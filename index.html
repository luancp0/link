<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>MiniGame Ki·ªÉm Tra</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #fff;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #fbc531;
    }
    .game-container {
      display: flex;
      justify-content: space-around;
      margin-top: 40px;
      flex-wrap: wrap;
    }
    .game {
      background: #2f3640;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      margin: 10px;
      opacity: 0.6;
      pointer-events: none;
    }
    button {
      background: #00a8ff;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .timer {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
    }
    .drop-target {
      border: 2px dashed #fff;
      height: 50px;
      margin-top: 10px;
    }
    .blocked {
      color: red;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üéÆ MiniGame - Ki·ªÉm tra nƒÉng l·ª±c & Ki√™n nh·∫´n üéÆ</h1>

  <div class="timer">
    ‚è≥ Th·ªùi gian ch·ªù tr∆∞·ªõc khi ch∆°i game: <span id="play-timer">10</span> gi√¢y<br>
    üïí Th·ªùi gian ch·ªù to√†n trang: <span id="page-timer">120</span> gi√¢y
  </div>

  <div class="blocked" id="block-warning" style="display:none;">
    ‚ö†Ô∏è B·∫°n ƒë√£ b·ªã c·∫•m v√¨ ph√°t hi·ªán gian l·∫≠n! Th·ª≠ l·∫°i sau v√†i ph√∫t.
  </div>

  <div class="game-container" id="games">
    <!-- Game 1 -->
    <div class="game" id="game1">
      <h3>Game 1: Ghi nh·ªõ m√†u</h3>
      <div class="timer">‚è± Nh·ªõ chu·ªói: <span id="game1-timer">--</span></div>
      <div id="color-sequence"></div>
      <input id="color-input" placeholder="Nh·∫≠p chu·ªói (VD: ƒë·ªè,xanh,...)"><br><br>
      <button onclick="checkMemory()">G·ª≠i</button>
      <p id="game1-status"></p>
    </div>

    <!-- Game 2 -->
    <div class="game" id="game2">
      <h3>Game 2: ƒê·∫øm h√¨nh</h3>
      <div class="timer">‚è± Ch·ªù: <span id="game2-timer">40</span>s</div>
      <div id="count-area"></div>
      <input id="count-input" type="number" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng"><br><br>
      <button onclick="checkCount()">Ki·ªÉm tra</button>
      <p id="game2-status"></p>
    </div>

    <!-- Game 3 -->
    <div class="game" id="game3">
      <h3>Game 3: K√©o th·∫£</h3>
      <div class="timer">‚è± Ch·ªù: <span id="game3-timer">40</span>s</div>
      <div draggable="true" id="circle" style="width:40px;height:40px;background:orange;border-radius:50%;margin:10px;" ondragstart="drag(event)"></div>
      <div id="dropzone" class="drop-target" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
      <p id="game3-status"></p>
    </div>
  </div>

  <script>
    // ‚úÖ KH√îNG c·∫ßn REDIRECT_URL n·ªØa
    // const REDIRECT_URL = "https://v0-new-project-hpzkcjchesg.vercel.app/";

    let game1Completed = false;
    let game2Completed = false;
    let game3Completed = false;
    let pageReady = false;

    let playWait = 10;
    let pageWait = 120;

    const timers = {
      game2: 40,
      game3: 40
    };

    const startTimes = {
      game2: Date.now(),
      game3: Date.now()
    };

    // ƒê·∫øm ng∆∞·ª£c m·ªü ch∆°i
    const playTimer = setInterval(() => {
      playWait--;
      document.getElementById("play-timer").innerText = playWait;
      if (playWait <= 0) {
        clearInterval(playTimer);
        enableGames();
      }
    }, 1000);

    // ƒê·∫øm ng∆∞·ª£c to√†n trang
    const pageTimer = setInterval(() => {
      pageWait--;
      document.getElementById("page-timer").innerText = pageWait;
      if (pageWait <= 0) {
        clearInterval(pageTimer);
        pageReady = true;
        redirectIfReady();
      }
    }, 1000);

    function enableGames() {
      const games = document.querySelectorAll(".game");
      games.forEach(g => {
        g.style.opacity = "1";
        g.style.pointerEvents = "auto";
      });

      Object.keys(timers).forEach(game => {
        const interval = setInterval(() => {
          timers[game]--;
          document.getElementById(`${game}-timer`).innerText = timers[game];
          if (timers[game] <= 0) clearInterval(interval);
        }, 1000);
      });

      document.getElementById("game1-timer").innerText = "--";
    }

    // Game 1 - Ghi nh·ªõ m√†u
    const colors = ["ƒë·ªè", "xanh", "v√†ng", "t√≠m", "cam"];
    const sequence = Array.from({ length: 4 }, () => colors[Math.floor(Math.random() * colors.length)]);
    document.getElementById('color-sequence').innerText = sequence.join(", ");

    function checkMemory() {
      const input = document.getElementById('color-input').value.toLowerCase().replace(/\s+/g, '').replace(/,/g, '');
      const target = sequence.join('').toLowerCase();

      if (input === target) {
        game1Completed = true;
        document.getElementById('game1-status').innerText = "‚úÖ Ho√†n th√†nh!";
        redirectIfReady();
      } else {
        document.getElementById('game1-status').innerText = "‚ùå Sai r·ªìi! Chu·ªói l√†: " + sequence.join(", ");
        document.getElementById('color-sequence').innerText = sequence.join(", ");
      }
    }

    // Game 2
    let correctCount = 0;
    const area = document.getElementById('count-area');
    for (let i = 0; i < 20; i++) {
      const div = document.createElement('div');
      div.style.width = div.style.height = "20px";
      div.style.display = "inline-block";
      div.style.margin = "2px";
      const isYellow = Math.random() < 0.4;
      if (isYellow) {
        div.style.background = "yellow";
        correctCount++;
      } else {
        div.style.background = "gray";
      }
      area.appendChild(div);
    }

    function checkCount() {
      const val = parseInt(document.getElementById('count-input').value);
      const duration = (Date.now() - startTimes.game2) / 1000;

      if (val === correctCount && duration >= 40) {
        game2Completed = true;
        document.getElementById('game2-status').innerText = "‚úÖ Ch√≠nh x√°c!";
        redirectIfReady();
      } else {
        alert("Sai ho·∫∑c ch∆∞a ƒë·ªß th·ªùi gian.");
      }
    }

    // Game 3
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    function drop(ev) {
      ev.preventDefault();
      const data = ev.dataTransfer.getData("text");
      const duration = (Date.now() - startTimes.game3) / 1000;

      if (duration >= 40) {
        ev.target.appendChild(document.getElementById(data));
        game3Completed = true;
        document.getElementById('game3-status').innerText = "‚úÖ Th·∫£ ƒë√∫ng!";
        redirectIfReady();
      } else {
        alert("Ch·ªù ƒë·ªß 40 gi√¢y ƒë·ªÉ ho√†n th√†nh.");
      }
    }

    // ‚úÖ THAY th·∫ø redirect tr·ª±c ti·∫øp b·∫±ng g·ª≠i th√¥ng ƒëi·ªáp ra ngo√†i
    function redirectIfReady() {
      if (game1Completed && game2Completed && game3Completed && pageReady) {
        setTimeout(() => {
          // G·ª≠i s·ª± ki·ªán ra ngo√†i iframe ƒë·ªÉ Blogger x·ª≠ l√Ω
          window.parent.postMessage("GAME_COMPLETED", "*");
        }, 1000);
      }
    }
  </script>
</body>
</html>
